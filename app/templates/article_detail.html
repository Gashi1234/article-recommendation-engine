{% extends "base.html" %}

{% block content %}
  <h2>{{ article.title }}</h2>
  <p><strong>Category:</strong> {{ article.category_name or "" }}</p>
  <p>{{ article.content }}</p>
  
  <div style="display: flex; align-items: center; gap: 20px; margin: 12px 0;">
    <div><strong>Views:</strong> {{ views }}</div>
    <div><strong>Likes:</strong> <span id="likes">{{ likes }}</span></div>
    <button id="likeBtn" data-article-id="{{ article.id }}">
      Like üëç
    </button>
  </div>  

  <p><a href="/">Go back to previous page</a></p>

  <hr>

        <div style="display: flex; gap: 24px; align-items: flex-start;">
          <div style="flex: 1; min-width: 320px;">
            <h3 style="margin-top: 0;">Recommended for you</h3>

            {% if recommendations and recommendations|length > 0 %}
              <ul>
                {% for a in recommendations %}
                  <li style="margin-bottom: 6px;">
                    <a href="/articles/{{ a.id }}">{{ a.title }}</a>
                    {% if a.category_name %} ({{ a.category_name }}) {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p>No recommendations available yet.</p>
            {% endif %}
          </div>

          <div style="width: 260px;">
            <h4 style="margin-top: 0;">Recommendations based on</h4>

            <form method="get" action="/articles/{{ article.id }}">
              <select name="strategy" style="width: 100%; padding: 8px;">
                <option value="popular" {% if rec_strategy == "popular" %}selected{% endif %}>Popularity</option>
                <option value="content" {% if rec_strategy == "content" %}selected{% endif %}>Content</option>
              </select>

              <button type="submit" style="margin-top: 10px; padding: 8px 12px; width: 100%;">
                Show
              </button>
            </form>
          </div>
        </div>



  <!-- Like eventi -->
  <script>
    const likeBtn = document.getElementById("likeBtn");
    likeBtn.onclick = function () {
      const articleId = this.dataset.articleId;

      fetch("/api/events", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          article_id: parseInt(articleId),
          event_type: "like"
        })
      })
      .then(res => {
        if (res.ok) {
            const likesSpan = document.getElementById("likes");
            likesSpan.textContent = parseInt(likesSpan.textContent) + 1;
          }

      })
      .catch(err => console.error(err));
    };
  </script>

  <!-- Time spent tracking -->
  <script>
    (function () {
      const articleId = {{ article.id }};
      const start = Date.now();
      let sent = false;

      function sendTimeSpent() {
        if (sent) return;
        sent = true;

        const durationMs = Date.now() - start;
        if (durationMs < 1000) return;

        const payload = JSON.stringify({
          article_id: articleId,
          event_type: "time_spent",
          duration_ms: durationMs
        });

        if (navigator.sendBeacon) {
          const blob = new Blob([payload], { type: "application/json" });
          navigator.sendBeacon("/api/events", blob);
          return;
        }

        fetch("/api/events", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: payload,
          keepalive: true
        }).catch(() => {});
      }

      window.addEventListener("beforeunload", sendTimeSpent);
      document.addEventListener("visibilitychange", function () {
        if (document.visibilityState === "hidden") {
          sendTimeSpent();
        }
      });
    })();
  </script>

{% endblock %}
